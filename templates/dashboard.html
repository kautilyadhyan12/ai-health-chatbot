{% extends "base.html" %}

{% block title %}Dashboard - MedAI Assistant{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/charts.css') }}">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    
    .realtime-status {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 15px;
        background: rgba(16, 185, 129, 0.1);
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        color: #064e3b;
    }

    .realtime-status .status-dot {
        width: 10px;
        height: 10px;
        background: #10b981;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    .realtime-info {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 10px;
        font-size: 0.9rem;
        color: #059669;
    }

    .stat-trend.up span {
        color: #059669;
    }

    .stat-trend.down span {
        color: #047857;
    }

    /* Animations */
    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
            transform: scale(1);
        }

        50% {
            opacity: 0.7;
            transform: scale(1.1);
        }
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }

        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }

    
    .dashboard-welcome h2,
    .dashboard-welcome p,
    .top-bar-left h1,
    .top-bar-left p,
    .stat-info p,
    .chart-header h3,
    .quick-actions h3,
    .action-btn span {
        color: #064e3b !important;
    }

    .health-score {
        color: #047857 !important;
    }

    .health-trend.up {
        color: #059669 !important;
    }

    /* Sidebar toggle alignment */
    .sidebar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid var(--light-border);
    }

    .sidebar-logo {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex: 1;
    }

    .sidebar-logo h2 {
        font-size: 1.25rem;
        color: #064e3b;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .sidebar-logo span {
        color: #10b981;
    }

    .sidebar-toggle {
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: var(--radius-md);
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #065f46;
        transition: all 0.3s ease;
        flex-shrink: 0;
        margin-left: 0.5rem;
    }

    .sidebar-toggle:hover {
        background: #10b981;
        color: white;
        border-color: #10b981;
        transform: scale(1.05);
    }

    
    .user-profile {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1.5rem;
        border-bottom: 1px solid var(--light-border);
    }

    .user-info h3 {
        margin-bottom: 0.25rem;
        color: #064e3b;
        font-size: 1rem;
    }

    .user-role {
        color: #10b981;
        font-size: 0.875rem;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="fas fa-heartbeat medical-icon" style="color: #10b981;"></i>
                <h2>Med<span>AI</span></h2>
            </div>
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>

        <div class="user-profile">
            <div class="avatar">
                <i class="fas fa-user-md" style="color: white;"></i>
            </div>
            <div class="user-info">
                <h3 id="usernameDisplay" style="color: #064e3b;">{{ username }}</h3>
                <p class="user-role">Premium Member</p>
                <div class="user-status">
                    <span class="status-dot"></span>
                    <span style="color: #065f46;">AI Online</span>
                </div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <a href="#dashboard" class="nav-item active" data-section="dashboard">
                <i class="fas fa-home"></i>
                <span style="color: #064e3b;">Dashboard</span>
            </a>
            <a href="#chat" class="nav-item" data-section="chat">
                <i class="fas fa-comment-medical"></i>
                <span style="color: #064e3b;">AI Chat Assistant</span>
                <span class="badge">New</span>
            </a>

            <a href="#history" class="nav-item" data-section="history">
                <i class="fas fa-history"></i>
                <span style="color: #064e3b;">Chat History</span>
            </a>
            <a href="#settings" class="nav-item" data-section="settings">
                <i class="fas fa-cog"></i>
                <span style="color: #064e3b;">Settings</span>
            </a>

            <div class="nav-divider"></div>

            <a href="/logout" class="nav-item logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                <span style="color: #064e3b;">Logout</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <div class="health-tip">
                <i class="fas fa-lightbulb" style="color: #10b981;"></i>
                <div>
                    <h4 style="color: #064e3b;">Daily Health Tip</h4>
                    <p id="healthTip" style="color: #065f46;">Stay hydrated! Drink at least 8 glasses of water daily.
                    </p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        
        <header class="top-bar">
            <div class="top-bar-left">
                <h1 id="pageTitle" style="color: #064e3b;">Welcome to Your Dashboard</h1>
                <p id="pageSubtitle" style="color: #065f46;">Your AI medical insights update in real-time</p>
            </div>

            <div class="top-bar-right">
                <div class="realtime-status">
                    <span class="status-dot active"></span>
                    <span style="color: #064e3b;">Live Updates: <strong style="color: #059669;">Active</strong></span>
                </div>
                <button class="new-chat-btn" id="newChatBtn">
                    <i class="fas fa-comment-medical"></i>
                    <span>Start New Chat</span>
                </button>
            </div>
        </header>

        <!-- Dashboard Section -->
        <section id="dashboardSection" class="content-section active">
            <div class="dashboard-welcome">
                <div class="welcome-card medical-card">
                    <h2 style="color: #064e3b; font-weight: 700; font-size: 2.5rem;">
                        Welcome back,
                        <span id="userGreeting" style="
                color: #064e3b !important;
                font-weight: 900 !important;
                text-shadow: 1px 1px 3px rgba(6, 78, 59, 0.2);
                padding: 0 8px;
                border-radius: 8px;
                background: linear-gradient(135deg, rgba(6, 78, 59, 0.1), rgba(5, 150, 105, 0.1));
                display: inline-block;
                transform: translateY(-2px);
            ">{{ username }}</span>! üë®‚Äç‚öïÔ∏è
                    </h2>
                    <p style="color: #064e3b;">Your AI medical assistant is ready to help. Ask any health-related
                        question or check your analytics below.</p>

                    <div class="health-status">
                        <div class="health-meter">
                            <div class="health-fill" style="width: 85%"></div>
                        </div>
                        <div class="health-info">
                            <span class="health-score" style="color: #047857; font-weight: 600;">Health Score:
                                85%</span>
                            <span class="health-trend up" style="color: #059669; font-weight: 500;">‚Üë 5% from last
                                week</span>
                        </div>
                    </div>

                    <div class="quick-actions-medical">
                        <button class="symptom-tag">
                            <i class="fas fa-head-side-cough"></i>
                            Symptom Check
                        </button>
                        <button class="symptom-tag">
                            <i class="fas fa-heartbeat"></i>
                            Vital Signs
                        </button>
                        <button class="symptom-tag">
                            <i class="fas fa-pills"></i>
                            Medications
                        </button>
                    </div>
                </div>
            </div>

            
            <div class="quick-stats">
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalChats" style="color: #064e3b;">{{ user_stats.total_chats }}</h3>
                        <p style="color: #065f46;">Total Chats</p>
                    </div>
                    <div class="stat-trend up">
                        <i class="fas fa-arrow-up"></i>
                        <span style="color: #059669;">Live</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="fas fa-heartbeat"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="avgConfidence" style="color: #064e3b;">{{ user_stats.avg_confidence }}%</h3>
                        <p style="color: #065f46;">Avg. Confidence</p>
                    </div>
                    <div class="stat-trend up">
                        <i class="fas fa-arrow-up"></i>
                        <span style="color: #059669;">Live</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="commonIntent" style="color: #064e3b;">{{ user_stats.most_common_intent }}</h3>
                        <p style="color: #065f46;">Most Common Intent</p>
                    </div>
                    <div class="stat-trend">
                        <i class="fas fa-sync-alt"></i>
                        <span style="color: #047857;">Live</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="lastActive" style="color: #064e3b;">{{ user_stats.last_active }}</h3>
                        <p style="color: #065f46;">Last Active</p>
                    </div>
                    <div class="stat-trend down">
                        <i class="fas fa-broadcast-tower"></i>
                        <span style="color: #047857;">Live</span>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 style="color: #064e3b;">Chat Activity</h3>
                        <select id="chartRange">
                            <option value="7">Last 7 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                        </select>
                    </div>
                    <div class="chart-container" style="height: 250px; max-height: 250px;">
                        <canvas id="activityChart" height="250"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 style="color: #064e3b;">Intent Distribution</h3>
                        <div class="chart-legend">
                            <span class="legend-item"><i class="fas fa-circle" style="color: #667eea;"></i>
                                Symptom</span>
                            <span class="legend-item"><i class="fas fa-circle" style="color: #f093fb;"></i>
                                Medication</span>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 250px; max-height: 250px;">
                        <canvas id="intentChart" height="250"></canvas>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <h3 style="color: #064e3b;">Quick Actions</h3>
                <div class="actions-grid">
                    <button class="action-btn" data-action="emergency">
                        <i class="fas fa-ambulance"></i>
                        <span style="color: #064e3b;">Emergency Help</span>
                    </button>
                    <button class="action-btn" data-action="download">
                        <i class="fas fa-download"></i>
                        <span style="color: #064e3b;">Download History</span>
                    </button>
                    <button class="action-btn" data-action="clear">
                        <i class="fas fa-trash"></i>
                        <span style="color: #064e3b;">Clear Chat</span>
                    </button>
                    <button class="action-btn" data-action="faq">
                        <i class="fas fa-question-circle"></i>
                        <span style="color: #064e3b;">View FAQ</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Chat Section -->
        <section id="chatSection" class="content-section">
            <div class="chat-container">
                <div class="chat-header">
                    <div class="chat-info">
                        <div class="ai-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div>
                            <h3 style="color: #064e3b;">MedAI Medical Assistant</h3>
                            <div class="chat-status">
                                <span class="status-dot active"></span>
                                <span style="color: #065f46;">Online - Powered by LLaMA-3 8B</span>
                            </div>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="chat-action-btn" title="Voice Input">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button class="chat-action-btn" title="Clear Chat" id="clearChatBtn">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="chat-action-btn" title="Export Chat">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <!-- Welcome message -->
                    <div class="message ai-message">
                        <div class="message-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <strong style="color: #064e3b;">MedAI Assistant</strong>
                                <span class="message-time">Just now</span>
                            </div>
                            <p style="color: #065f46;">Hello! I'm your AI medical assistant powered by LLaMA-3 8B and
                                Retrieval-Augmented
                                Generation system. I can help with:</p>
                            <ul>
                                <li style="color: #065f46;">Understanding symptoms and conditions</li>
                                <li style="color: #065f46;">General health information</li>
                                <li style="color: #065f46;">Medication information</li>
                                <li style="color: #065f46;">Lifestyle advice</li>
                            </ul>
                            <p style="color: #064e3b;"><strong>‚ö†Ô∏è Important:</strong> I provide information only, not
                                medical advice. Always
                                consult healthcare professionals for medical concerns.</p>
                            <p style="color: #065f46;">How can I assist you today?</p>
                        </div>
                    </div>
                </div>

                <div class="chat-input-area">
                    <div class="input-container">
                        <textarea id="userInput"
                            placeholder="Type your health-related question here... (e.g., What are common flu symptoms?)"
                            rows="1" style="color: #064e3b;"></textarea>
                        <div class="input-actions">
                            <button class="input-action-btn" title="Attach File">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button class="input-action-btn" title="Emoji">
                                <i class="far fa-smile"></i>
                            </button>
                            <button id="sendMessageBtn" class="send-btn">
                                <i class="fas fa-paper-plane"></i>
                                <span>Send</span>
                            </button>
                        </div>
                    </div>
                    <div class="input-footer">
                        <div class="safety-notice">
                            <i class="fas fa-shield-alt"></i>
                            <span style="color: #065f46;">Your conversation is private and secure</span>
                        </div>
                        <div class="quick-prompts">
                            <button class="quick-prompt" data-prompt="What are flu symptoms?">Flu Symptoms</button>
                            <button class="quick-prompt" data-prompt="How to lower blood pressure?">Blood
                                Pressure</button>
                            <button class="quick-prompt" data-prompt="What is healthy diet?">Healthy Diet</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-sidebar">
                <div class="sidebar-card">
                    <h4 style="color: #064e3b;"><i class="fas fa-info-circle"></i> Chat Information</h4>
                    <div class="info-item">
                        <span class="info-label" style="color: #065f46;">Session ID:</span>
                        <span id="sessionId" style="color: #064e3b;">MED-{{ '%06d' % range(100000, 999999) | random
                            }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label" style="color: #065f46;">AI Model:</span>
                        <span style="color: #064e3b;">LLaMA-3 8B + FAISS RAG</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label" style="color: #065f46;">Safety Level:</span>
                        <span class="safety-level safe">Active Monitoring</span>
                    </div>
                </div>

                <div class="sidebar-card">
                    <h4 style="color: #064e3b;"><i class="fas fa-bolt"></i> Quick Responses</h4>
                    <div class="quick-response"
                        data-response="I understand you're asking about symptoms. Could you please describe them in more detail?">
                        <i class="fas fa-stethoscope"></i>
                        <span style="color: #064e3b;">Ask for symptom details</span>
                    </div>
                    <div class="quick-response"
                        data-response="For medication information, please consult with a healthcare provider who knows your medical history.">
                        <i class="fas fa-pills"></i>
                        <span style="color: #064e3b;">Medication disclaimer</span>
                    </div>
                    <div class="quick-response emergency"
                        data-response="‚ö†Ô∏è EMERGENCY: Please seek immediate medical attention or call emergency services (911/112)!">
                        <i class="fas fa-ambulance"></i>
                        <span style="color: #064e3b;">Emergency response</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- History Section -->
        <section id="historySection" class="content-section">
            <div class="history-header">
                <h2 style="color: #064e3b;">Chat History</h2>
                <div class="history-controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="historySearch" placeholder="Search conversations..."
                            style="color: #064e3b;">
                    </div>
                    <select id="historyFilter">
                        <option value="all">All Conversations</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                    <button class="btn btn-secondary" id="deleteAllBtn">
                        <i class="fas fa-trash"></i>
                        Delete All
                    </button>
                    <button class="btn btn-primary" id="downloadHistoryBtn">
                        <i class="fas fa-download"></i>
                        Export CSV
                    </button>
                </div>
            </div>

            <div class="history-list" id="historyList">
                
                <div class="history-placeholder">
                    <i class="fas fa-history"></i>
                    <h3 style="color: #064e3b;">No chat history yet</h3>
                    <p style="color: #065f46;">Start a conversation with MedAI Assistant to see your history here.</p>
                    <button class="btn btn-primary" id="startChatFromHistory">
                        <i class="fas fa-comment-medical"></i>
                        Start a Chat
                    </button>
                </div>
            </div>

            <div class="pagination" id="historyPagination">
                
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settingsSection" class="content-section">
            <div class="settings-header">
                <h2 style="color: #064e3b;">Account Settings</h2>
                <p style="color: #065f46;">Manage your MedAI Assistant preferences and account details</p>
            </div>

            <div class="settings-grid">
                <div class="settings-card">
                    <h3 style="color: #064e3b;"><i class="fas fa-user-cog"></i> Profile Settings</h3>
                    <div class="setting-item">
                        <label style="color: #065f46;">Username</label>
                        <input type="text" id="usernameInput" value="{{ username }}" disabled style="color: #064e3b;">
                    </div>
                    <div class="setting-item">
                        <label style="color: #065f46;">Email Notifications</label>
                        <label class="toggle-switch">
                            <input type="checkbox" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <button class="btn btn-primary">Update Profile</button>
                </div>

                <div class="settings-card">
                    <h3 style="color: #064e3b;"><i class="fas fa-shield-alt"></i> Privacy & Security</h3>
                    <div class="setting-item">
                        <label style="color: #065f46;">Auto-delete History</label>
                        <select style="color: #064e3b;">
                            <option>Never</option>
                            <option>After 30 days</option>
                            <option>After 90 days</option>
                            <option>After 1 year</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label style="color: #065f46;">Data Sharing</label>
                        <label class="toggle-switch">
                            <input type="checkbox">
                            <span class="toggle-slider"></span>
                        </label>
                        <small style="color: #065f46;">Allow anonymous usage data to improve AI</small>
                    </div>
                </div>

                <div class="settings-card">
                    <h3 style="color: #064e3b;"><i class="fas fa-robot"></i> AI Preferences</h3>
                    <div class="setting-item">
                        <label style="color: #065f46;">Response Detail Level</label>
                        <select style="color: #064e3b;">
                            <option>Detailed (Recommended)</option>
                            <option>Brief</option>
                            <option>Technical</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label style="color: #065f46;">Safety Sensitivity</label>
                        <div class="range-slider">
                            <input type="range" min="1" max="5" value="3">
                            <div class="range-labels">
                                <span style="color: #065f46;">Low</span>
                                <span style="color: #065f46;">Medium</span>
                                <span style="color: #065f46;">High</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

<!-- Socket.IO Status Monitor  -->
<div id="socketStatusMonitor"
    style="display: none; position: fixed; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; z-index: 9999;">
    Socket.IO: <span id="socketStatus">Connecting...</span>
</div>


<div id="alertContainer"></div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/script.js') }}"></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>


<script>
    
    function handleDashboardUpdate(data) {
        console.log('üì° Dashboard update handler called:', data);

        if (data && data.stats) {
            updateDashboardStats(data.stats);
            showUpdateNotification('Dashboard updated in real-time!');

            
            if (data.stats.charts) {
                if (typeof updateChartsRealTime === 'function') {
                    updateChartsRealTime(data.stats.charts);
                }
            }
        }
    }

    
    function onSocketConnected() {
        console.log('üéØ Dashboard: Socket.IO ready for real-time updates');
        showConnectionNotification('Live updates connected', 'success');

        
        const monitor = document.getElementById('socketStatusMonitor');
        if (monitor) monitor.style.display = 'block';

        
        fetch('/api/analytics')
            .then(response => response.json())
            .then(data => {
                if (data.summary) {
                    updateDashboardStats({
                        total_chats: data.summary.total_chats || 0,
                        avg_confidence: data.summary.avg_confidence || 0,
                        most_common_intent: data.summary.most_common_intent || 'N/A',
                        last_active: 'Just now'
                    });
                }
            });
    }

    
    function updateDashboardStats(stats) {
        console.log('üîÑ Updating dashboard stats:', stats);

        
        const totalChatsEl = document.getElementById('totalChats');
        if (totalChatsEl) {
            totalChatsEl.textContent = stats.total_chats;
            totalChatsEl.style.transform = 'scale(1.1)';
            totalChatsEl.style.color = '#064e3b';
            setTimeout(() => totalChatsEl.style.transform = 'scale(1)', 300);
        }

        
        const avgConfidenceEl = document.getElementById('avgConfidence');
        if (avgConfidenceEl) {
            avgConfidenceEl.textContent = stats.avg_confidence + '%';
            avgConfidenceEl.style.color = '#064e3b';
            if (stats.avg_confidence >= 80) {
                avgConfidenceEl.style.color = '#10b981';
            } else if (stats.avg_confidence >= 60) {
                avgConfidenceEl.style.color = '#f59e0b';
            } else {
                avgConfidenceEl.style.color = '#ef4444';
            }
        }

        
        const commonIntentEl = document.getElementById('commonIntent');
        if (commonIntentEl) {
            commonIntentEl.textContent = stats.most_common_intent;
            commonIntentEl.style.color = '#064e3b';
            if (stats.most_common_intent !== 'N/A') {
                commonIntentEl.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(13, 148, 136, 0.2))';
                commonIntentEl.style.color = '#065f46';
                commonIntentEl.style.padding = '2px 8px';
                commonIntentEl.style.borderRadius = '12px';
                commonIntentEl.style.fontSize = '0.9em';
            }
        }

        
        const lastActiveEl = document.getElementById('lastActive');
        if (lastActiveEl) {
            lastActiveEl.textContent = stats.last_active;
            lastActiveEl.style.color = '#064e3b';
            if (stats.last_active === 'Just now' || stats.last_active.includes('min ago')) {
                lastActiveEl.style.color = '#10b981';
                lastActiveEl.style.fontWeight = 'bold';
            }
        }
    }

  
    function showConnectionNotification(message, type) {
        showNotification(message, type, 3000);
    }

    function showUpdateNotification(message) {
        showNotification(message, 'info', 2000);
    }

    function showNotification(message, type, duration) {
        
        const existing = document.querySelector('.socket-notification');
        if (existing) existing.remove();

        const notification = document.createElement('div');
        notification.className = `socket-notification ${type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
            <span>${message}</span>
        `;

        notification.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: ${type === 'success' ? 'rgba(16, 185, 129, 0.9)' : type === 'warning' ? 'rgba(245, 158, 11, 0.9)' : 'rgba(102, 126, 234, 0.9)'};
            color: white;
            padding: 12px 18px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentElement) {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }
        }, duration);
    }

    
    function monitorSocketStatus() {
        setInterval(() => {
            const statusEl = document.getElementById('socketStatus');
            if (socket) {
                const status = socket.connected ? '‚úÖ Connected' : '‚ùå Disconnected';
                const color = socket.connected ? '#10b981' : '#ef4444';
                statusEl.textContent = status;
                statusEl.style.color = color;

                
                const realtimeStatus = document.querySelector('.realtime-status strong');
                if (realtimeStatus) {
                    realtimeStatus.textContent = socket.connected ? 'Active' : 'Inactive';
                    realtimeStatus.style.color = color;
                }
            }
        }, 1000);
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function () {
        console.log('üìã Dashboard initialized, waiting for real-time updates...');

        
        const sidebarToggle = document.getElementById('sidebarToggle');
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', () => {
                const sidebar = document.querySelector('.sidebar');
                sidebar.classList.toggle('collapsed');

                const icon = sidebarToggle.querySelector('i');
                if (sidebar.classList.contains('collapsed')) {
                    icon.className = 'fas fa-chevron-right';
                } else {
                    icon.className = 'fas fa-chevron-left';
                }
            });
        }

        
        monitorSocketStatus();

        
        setTimeout(() => {
            if (!socket || !socket.connected) {
                showNotification('Connecting to live updates...', 'info', 3000);
            }
        }, 1000);

        
        const originalSendMessage = window.dashboard ? window.dashboard.sendMessage : null;
        if (originalSendMessage) {
            window.dashboard.sendMessage = async function () {
                try {
                    await originalSendMessage.call(this);
                    
                    showUpdateNotification('Chat saved! Dashboard updated.');
                } catch (error) {
                    console.error('Chat error:', error);
                }
            };
        }
    });
</script>
{% endblock %}