{% extends "base.html" %}

{% block title %}Dashboard - MedAI Assistant{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/charts.css') }}">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    .realtime-status {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 15px;
        background: rgba(102, 126, 234, 0.1);
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        color: var(--gray-700);
    }

    .realtime-status .status-dot {
        width: 10px;
        height: 10px;
        background: #48bb78;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    .realtime-info {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 10px;
        font-size: 0.9rem;
        color: #667eea;
    }

    .stat-trend.up span {
        color: #48bb78;
    }

    .stat-trend.down span {
        color: #667eea;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
            transform: scale(1);
        }

        50% {
            opacity: 0.7;
            transform: scale(1.1);
        }
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }

        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-heartbeat"></i>
                <h2>MedAI<span>Assistant</span></h2>
            </div>
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>

        <div class="user-profile">
            <div class="avatar">
                <i class="fas fa-user-md"></i>
            </div>
            <div class="user-info">
                <h3 id="usernameDisplay">{{ username }}</h3>
                <p class="user-role">Premium Member</p>
                <div class="user-status">
                    <span class="status-dot"></span>
                    <span>AI Online</span>
                </div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <a href="#dashboard" class="nav-item active" data-section="dashboard">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <a href="#chat" class="nav-item" data-section="chat">
                <i class="fas fa-comment-medical"></i>
                <span>AI Chat Assistant</span>
                <span class="badge">New</span>
            </a>
            <a href="#analytics" class="nav-item" data-section="analytics">
                <i class="fas fa-chart-bar"></i>
                <span>Health Analytics</span>
            </a>
            <a href="#history" class="nav-item" data-section="history">
                <i class="fas fa-history"></i>
                <span>Chat History</span>
            </a>
            <a href="#settings" class="nav-item" data-section="settings">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>

            <div class="nav-divider"></div>

            <a href="/logout" class="nav-item logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <div class="health-tip">
                <i class="fas fa-lightbulb"></i>
                <div>
                    <h4>Daily Health Tip</h4>
                    <p id="healthTip">Stay hydrated! Drink at least 8 glasses of water daily.</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Clean Top Bar - Removed notifications and search -->
        <header class="top-bar">
            <div class="top-bar-left">
                <h1 id="pageTitle">Welcome to Your Dashboard</h1>
                <p id="pageSubtitle">Your AI medical insights update in real-time</p>
            </div>

            <div class="top-bar-right">
                <div class="realtime-status">
                    <span class="status-dot active"></span>
                    <span>Live Updates: <strong>Active</strong></span>
                </div>
                <button class="new-chat-btn" id="newChatBtn">
                    <i class="fas fa-comment-medical"></i>
                    <span>Start New Chat</span>
                </button>
            </div>
        </header>

        <!-- Dashboard Section (Default) -->
        <section id="dashboardSection" class="content-section active">
            <div class="dashboard-welcome">
                <div class="welcome-card">
                    <h2>Welcome back, <span id="userGreeting">{{ username }}</span>! üëã</h2>
                    <p>Your AI medical assistant is ready to help. Ask any health-related question or check your
                        analytics below.</p>
                    <div class="realtime-info">
                        <i class="fas fa-broadcast-tower"></i>
                        <span>Dashboard updates in real-time as you chat</span>
                    </div>
                </div>
            </div>

            <!-- Quick Stats - These update in real-time -->
            <div class="quick-stats">
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalChats">{{ user_stats.total_chats }}</h3>
                        <p>Total Chats</p>
                    </div>
                    <div class="stat-trend up">
                        <i class="fas fa-arrow-up"></i>
                        <span>Live</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="fas fa-heartbeat"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="avgConfidence">{{ user_stats.avg_confidence }}%</h3>
                        <p>Avg. Confidence</p>
                    </div>
                    <div class="stat-trend up">
                        <i class="fas fa-arrow-up"></i>
                        <span>Live</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="commonIntent">{{ user_stats.most_common_intent }}</h3>
                        <p>Most Common Intent</p>
                    </div>
                    <div class="stat-trend">
                        <i class="fas fa-sync-alt"></i>
                        <span>Live</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="lastActive">{{ user_stats.last_active }}</h3>
                        <p>Last Active</p>
                    </div>
                    <div class="stat-trend down">
                        <i class="fas fa-broadcast-tower"></i>
                        <span>Live</span>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Chat Activity</h3>
                        <select id="chartRange">
                            <option value="7">Last 7 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                        </select>
                    </div>
                    <div class="chart-container" style="height: 250px; max-height: 250px;">
                        <canvas id="activityChart" height="250"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Intent Distribution</h3>
                        <div class="chart-legend">
                            <span class="legend-item"><i class="fas fa-circle" style="color: #667eea;"></i>
                                Symptom</span>
                            <span class="legend-item"><i class="fas fa-circle" style="color: #f093fb;"></i>
                                Medication</span>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 250px; max-height: 250px;">
                        <canvas id="intentChart" height="250"></canvas>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <h3>Quick Actions</h3>
                <div class="actions-grid">
                    <button class="action-btn" data-action="emergency">
                        <i class="fas fa-ambulance"></i>
                        <span>Emergency Help</span>
                    </button>
                    <button class="action-btn" data-action="download">
                        <i class="fas fa-download"></i>
                        <span>Download History</span>
                    </button>
                    <button class="action-btn" data-action="clear">
                        <i class="fas fa-trash"></i>
                        <span>Clear Chat</span>
                    </button>
                    <button class="action-btn" data-action="faq">
                        <i class="fas fa-question-circle"></i>
                        <span>View FAQ</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Chat Section -->
        <section id="chatSection" class="content-section">
            <div class="chat-container">
                <div class="chat-header">
                    <div class="chat-info">
                        <div class="ai-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div>
                            <h3>MedAI Medical Assistant</h3>
                            <div class="chat-status">
                                <span class="status-dot active"></span>
                                <span>Online - Powered by LLaMA-3 8B</span>
                            </div>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="chat-action-btn" title="Voice Input">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button class="chat-action-btn" title="Clear Chat" id="clearChatBtn">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="chat-action-btn" title="Export Chat">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <!-- Welcome message -->
                    <div class="message ai-message">
                        <div class="message-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <strong>MedAI Assistant</strong>
                                <span class="message-time">Just now</span>
                            </div>
                            <p>Hello! I'm your AI medical assistant powered by LLaMA-3 8B and Retrieval-Augmented
                                Generation system. I can help with:</p>
                            <ul>
                                <li>Understanding symptoms and conditions</li>
                                <li>General health information</li>
                                <li>Medication information</li>
                                <li>Lifestyle advice</li>
                            </ul>
                            <p><strong>‚ö†Ô∏è Important:</strong> I provide information only, not medical advice. Always
                                consult healthcare professionals for medical concerns.</p>
                            <p>How can I assist you today?</p>
                        </div>
                    </div>
                </div>

                <div class="chat-input-area">
                    <div class="input-container">
                        <textarea id="userInput"
                            placeholder="Type your health-related question here... (e.g., What are common flu symptoms?)"
                            rows="1"></textarea>
                        <div class="input-actions">
                            <button class="input-action-btn" title="Attach File">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button class="input-action-btn" title="Emoji">
                                <i class="far fa-smile"></i>
                            </button>
                            <button id="sendMessageBtn" class="send-btn">
                                <i class="fas fa-paper-plane"></i>
                                <span>Send</span>
                            </button>
                        </div>
                    </div>
                    <div class="input-footer">
                        <div class="safety-notice">
                            <i class="fas fa-shield-alt"></i>
                            <span>Your conversation is private and secure</span>
                        </div>
                        <div class="quick-prompts">
                            <button class="quick-prompt" data-prompt="What are flu symptoms?">Flu Symptoms</button>
                            <button class="quick-prompt" data-prompt="How to lower blood pressure?">Blood
                                Pressure</button>
                            <button class="quick-prompt" data-prompt="What is healthy diet?">Healthy Diet</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-sidebar">
                <div class="sidebar-card">
                    <h4><i class="fas fa-info-circle"></i> Chat Information</h4>
                    <div class="info-item">
                        <span class="info-label">Session ID:</span>
                        <span id="sessionId">MED-{{ '%06d' % range(100000, 999999) | random }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">AI Model:</span>
                        <span>LLaMA-3 8B + FAISS RAG</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Safety Level:</span>
                        <span class="safety-level safe">Active Monitoring</span>
                    </div>
                </div>

                <div class="sidebar-card">
                    <h4><i class="fas fa-bolt"></i> Quick Responses</h4>
                    <div class="quick-response"
                        data-response="I understand you're asking about symptoms. Could you please describe them in more detail?">
                        <i class="fas fa-stethoscope"></i>
                        <span>Ask for symptom details</span>
                    </div>
                    <div class="quick-response"
                        data-response="For medication information, please consult with a healthcare provider who knows your medical history.">
                        <i class="fas fa-pills"></i>
                        <span>Medication disclaimer</span>
                    </div>
                    <div class="quick-response emergency"
                        data-response="‚ö†Ô∏è EMERGENCY: Please seek immediate medical attention or call emergency services (911/112)!">
                        <i class="fas fa-ambulance"></i>
                        <span>Emergency response</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Analytics Section -->
        <section id="analyticsSection" class="content-section">
            <div class="analytics-header">
                <h2>Health Analytics Dashboard</h2>
                <p>Insights from your interactions with MedAI Assistant</p>
            </div>

            <div class="analytics-stats">
                <div class="analytics-card large">
                    <h3><i class="fas fa-chart-line"></i> Usage Trends</h3>
                    <div class="chart-container" style="height: 200px; max-height: 200px;">
                        <canvas id="usageChart" height="200"></canvas>
                    </div>
                </div>

                <div class="analytics-card">
                    <h3><i class="fas fa-brain"></i> AI Confidence</h3>
                    <div class="confidence-meter">
                        <div class="meter-value" style="width: 85%"></div>
                    </div>
                    <div class="confidence-info">
                        <span class="confidence-score">85%</span>
                        <span class="confidence-label">Average Accuracy</span>
                    </div>
                    <p>Based on response relevance and user feedback</p>
                </div>

                <div class="analytics-card">
                    <h3><i class="fas fa-tags"></i> Top Intents</h3>
                    <div class="intents-list" id="intentsList">
                        <!-- Will be populated by JS -->
                    </div>
                </div>
            </div>

            <div class="analytics-grid">
                <div class="analytics-card">
                    <h3><i class="fas fa-clock"></i> Peak Hours</h3>
                    <div class="chart-container" style="height: 200px; max-height: 200px;">
                        <canvas id="peakHoursChart" height="200"></canvas>
                    </div>
                </div>

                <div class="analytics-card">
                    <h3><i class="fas fa-calendar"></i> Monthly Summary</h3>
                    <div class="monthly-summary" id="monthlySummary" style="max-height: 180px; overflow-y: auto;">
                        <!-- Will be populated by JS -->
                    </div>
                </div>
            </div>
        </section>

        <!-- History Section -->
        <section id="historySection" class="content-section">
            <div class="history-header">
                <h2>Chat History</h2>
                <div class="history-controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="historySearch" placeholder="Search conversations...">
                    </div>
                    <select id="historyFilter">
                        <option value="all">All Conversations</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                    <button class="btn btn-secondary" id="deleteAllBtn">
                        <i class="fas fa-trash"></i>
                        Delete All
                    </button>
                    <button class="btn btn-primary" id="downloadHistoryBtn">
                        <i class="fas fa-download"></i>
                        Export CSV
                    </button>
                </div>
            </div>

            <div class="history-list" id="historyList">
                <!-- History items will be loaded here -->
                <div class="history-placeholder">
                    <i class="fas fa-history"></i>
                    <h3>No chat history yet</h3>
                    <p>Start a conversation with MedAI Assistant to see your history here.</p>
                    <button class="btn btn-primary" id="startChatFromHistory">
                        <i class="fas fa-comment-medical"></i>
                        Start a Chat
                    </button>
                </div>
            </div>

            <div class="pagination" id="historyPagination">
                <!-- Pagination will be added by JS -->
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settingsSection" class="content-section">
            <div class="settings-header">
                <h2>Account Settings</h2>
                <p>Manage your MedAI Assistant preferences and account details</p>
            </div>

            <div class="settings-grid">
                <div class="settings-card">
                    <h3><i class="fas fa-user-cog"></i> Profile Settings</h3>
                    <div class="setting-item">
                        <label>Username</label>
                        <input type="text" id="usernameInput" value="{{ username }}" disabled>
                    </div>
                    <div class="setting-item">
                        <label>Email Notifications</label>
                        <label class="toggle-switch">
                            <input type="checkbox" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <button class="btn btn-primary">Update Profile</button>
                </div>

                <div class="settings-card">
                    <h3><i class="fas fa-shield-alt"></i> Privacy & Security</h3>
                    <div class="setting-item">
                        <label>Auto-delete History</label>
                        <select>
                            <option>Never</option>
                            <option>After 30 days</option>
                            <option>After 90 days</option>
                            <option>After 1 year</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label>Data Sharing</label>
                        <label class="toggle-switch">
                            <input type="checkbox">
                            <span class="toggle-slider"></span>
                        </label>
                        <small>Allow anonymous usage data to improve AI</small>
                    </div>
                </div>

                <div class="settings-card">
                    <h3><i class="fas fa-robot"></i> AI Preferences</h3>
                    <div class="setting-item">
                        <label>Response Detail Level</label>
                        <select>
                            <option>Detailed (Recommended)</option>
                            <option>Brief</option>
                            <option>Technical</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label>Safety Sensitivity</label>
                        <div class="range-slider">
                            <input type="range" min="1" max="5" value="3">
                            <div class="range-labels">
                                <span>Low</span>
                                <span>Medium</span>
                                <span>High</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

<!-- Socket.IO Status Monitor (Hidden by default) -->
<div id="socketStatusMonitor"
    style="display: none; position: fixed; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; z-index: 9999;">
    Socket.IO: <span id="socketStatus">Connecting...</span>
</div>

<!-- Alert Container -->
<div id="alertContainer"></div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/script.js') }}"></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>

<!-- Real-time Dashboard Script -->
<script>
    // Global dashboard update handler
    function handleDashboardUpdate(data) {
        console.log('üì° Dashboard update handler called:', data);

        if (data && data.stats) {
            updateDashboardStats(data.stats);
            showUpdateNotification('Dashboard updated in real-time!');

            // Also update charts if data includes them
            if (data.stats.charts) {
                if (typeof updateChartsRealTime === 'function') {
                    updateChartsRealTime(data.stats.charts);
                }
            }
        }
    }

    // Socket connected handler
    function onSocketConnected() {
        console.log('üéØ Dashboard: Socket.IO ready for real-time updates');
        showConnectionNotification('Live updates connected', 'success');

        // Show status monitor
        const monitor = document.getElementById('socketStatusMonitor');
        if (monitor) monitor.style.display = 'block';

        // Request initial data
        fetch('/api/analytics')
            .then(response => response.json())
            .then(data => {
                if (data.summary) {
                    updateDashboardStats({
                        total_chats: data.summary.total_chats || 0,
                        avg_confidence: data.summary.avg_confidence || 0,
                        most_common_intent: data.summary.most_common_intent || 'N/A',
                        last_active: 'Just now'
                    });
                }
            });
    }

    // Update dashboard stats function
    function updateDashboardStats(stats) {
        console.log('üîÑ Updating dashboard stats:', stats);

        // Update Total Chats
        const totalChatsEl = document.getElementById('totalChats');
        if (totalChatsEl) {
            totalChatsEl.textContent = stats.total_chats;
            totalChatsEl.style.transform = 'scale(1.1)';
            setTimeout(() => totalChatsEl.style.transform = 'scale(1)', 300);
        }

        // Update Average Confidence
        const avgConfidenceEl = document.getElementById('avgConfidence');
        if (avgConfidenceEl) {
            avgConfidenceEl.textContent = stats.avg_confidence + '%';
            if (stats.avg_confidence >= 80) {
                avgConfidenceEl.style.color = '#48bb78';
            } else if (stats.avg_confidence >= 60) {
                avgConfidenceEl.style.color = '#ed8936';
            } else {
                avgConfidenceEl.style.color = '#f56565';
            }
        }

        // Update Most Common Intent
        const commonIntentEl = document.getElementById('commonIntent');
        if (commonIntentEl) {
            commonIntentEl.textContent = stats.most_common_intent;
            if (stats.most_common_intent !== 'N/A') {
                commonIntentEl.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                commonIntentEl.style.color = 'white';
                commonIntentEl.style.padding = '2px 8px';
                commonIntentEl.style.borderRadius = '12px';
                commonIntentEl.style.fontSize = '0.9em';
            }
        }

        // Update Last Active
        const lastActiveEl = document.getElementById('lastActive');
        if (lastActiveEl) {
            lastActiveEl.textContent = stats.last_active;
            if (stats.last_active === 'Just now' || stats.last_active.includes('min ago')) {
                lastActiveEl.style.color = '#48bb78';
                lastActiveEl.style.fontWeight = 'bold';
            }
        }
    }

    // Notification functions
    function showConnectionNotification(message, type) {
        showNotification(message, type, 3000);
    }

    function showUpdateNotification(message) {
        showNotification(message, 'info', 2000);
    }

    function showNotification(message, type, duration) {
        // Remove existing notification
        const existing = document.querySelector('.socket-notification');
        if (existing) existing.remove();

        const notification = document.createElement('div');
        notification.className = `socket-notification ${type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
            <span>${message}</span>
        `;

        notification.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: ${type === 'success' ? '#48bb78' : type === 'warning' ? '#ed8936' : '#667eea'};
            color: white;
            padding: 12px 18px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentElement) {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }
        }, duration);
    }

    // Monitor socket status
    function monitorSocketStatus() {
        setInterval(() => {
            const statusEl = document.getElementById('socketStatus');
            if (socket) {
                const status = socket.connected ? '‚úÖ Connected' : '‚ùå Disconnected';
                const color = socket.connected ? '#48bb78' : '#f56565';
                statusEl.textContent = status;
                statusEl.style.color = color;

                // Update real-time status in top bar
                const realtimeStatus = document.querySelector('.realtime-status strong');
                if (realtimeStatus) {
                    realtimeStatus.textContent = socket.connected ? 'Active' : 'Inactive';
                    realtimeStatus.style.color = color;
                }
            }
        }, 1000);
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function () {
        console.log('üìã Dashboard initialized, waiting for real-time updates...');

        // Start monitoring
        monitorSocketStatus();

        // Show connection status
        setTimeout(() => {
            if (!socket || !socket.connected) {
                showNotification('Connecting to live updates...', 'info', 3000);
            }
        }, 1000);

        // Add event listener for chat success
        const originalSendMessage = window.dashboard ? window.dashboard.sendMessage : null;
        if (originalSendMessage) {
            window.dashboard.sendMessage = async function () {
                try {
                    await originalSendMessage.call(this);
                    // After successful chat, show notification
                    showUpdateNotification('Chat saved! Dashboard updated.');
                } catch (error) {
                    console.error('Chat error:', error);
                }
            };
        }
    });
</script>
{% endblock %}